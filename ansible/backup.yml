---
- name: Sauvegarde complÃ¨te de l'infrastructure Docker
  hosts: localhost
  connection: local
  gather_facts: true

  vars:
    project_dir: "/ansible"
    backup_base_dir: "/ansible/backups"
    retention_days: 7
    volumes:
      - mariadb_data
      - glpi_data
      - influxdb_data
      - grafana_data
      - mongodb_data
    compose_file: "{{ project_dir }}/docker-compose.yml"
    # GÃ©nÃ©rer le timestamp UNE SEULE FOIS
    backup_timestamp: "{{ ansible_date_time.iso8601_basic_short }}"

  pre_tasks:
    - name: Installer les outils nÃ©cessaires
      shell: |
        apk add --no-cache docker-cli tar gzip curl jq
      args:
        creates: /usr/bin/docker
      register: install_tools

    - name: VÃ©rifier que Docker est accessible
      shell: docker ps -q
      register: docker_check
      failed_when: docker_check.rc != 0

    - name: Afficher les informations de dÃ©marrage
      debug:
        msg: |
          ğŸ”„ DÃ©but de la sauvegarde
          ğŸ“… Timestamp : {{ backup_timestamp }}
          ğŸ“ Base directory : {{ backup_base_dir }}

  tasks:
    - name: DÃ©finir le rÃ©pertoire de backup pour cette exÃ©cution
      set_fact:
        backup_dir: "{{ backup_base_dir }}/backup_{{ backup_timestamp }}"
        current_date: "{{ ansible_date_time.iso8601 }}"

    - name: CrÃ©er la structure des dossiers de backup
      file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
      loop:
        - "{{ backup_base_dir }}"
        - "{{ backup_dir }}"
        - "{{ backup_dir }}/databases"
        - "{{ backup_dir }}/volumes"
        - "{{ backup_dir }}/configs"
      register: backup_dirs_created

    - name: VÃ©rifier la crÃ©ation des rÃ©pertoires
      shell: |
        test -d "{{ backup_dir }}/configs" && echo "OK" || echo "FAILED"
      register: dir_check

    - name: ArrÃªter si les rÃ©pertoires ne sont pas crÃ©Ã©s
      fail:
        msg: "Impossible de crÃ©er les rÃ©pertoires de backup"
      when: dir_check.stdout != "OK"

    # ============ BACKUP DES FICHIERS DE CONFIG ============
    - name: Sauvegarder les fichiers de configuration
      block:
        - name: Copier .env
          copy:
            src: "{{ project_dir }}/.env"
            dest: "{{ backup_dir }}/configs/.env"
            remote_src: yes
          ignore_errors: yes
          register: env_backup

        - name: Copier docker-compose.yml
          copy:
            src: "{{ project_dir }}/docker-compose.yml"
            dest: "{{ backup_dir }}/configs/docker-compose.yml"
            remote_src: yes
          ignore_errors: yes
          register: compose_backup

        - name: Afficher rÃ©sultat backup configs
          debug:
            msg: |
              âœ“ .env : {% if env_backup.changed %}OK{% else %}SKIP{% endif %}
              âœ“ docker-compose.yml : {% if compose_backup.changed %}OK{% else %}SKIP{% endif %}

    # ============ BACKUP DES VOLUMES ============
    - name: Sauvegarder les volumes Docker
      shell: |
        set -e
        VOLUME="{{ item }}"
        BACKUP_FILE="{{ backup_dir }}/volumes/${VOLUME}.tar.gz"
        
        echo "ğŸ“¦ Sauvegarde du volume : $VOLUME"
        
        # VÃ©rifier que le volume existe
        if ! docker volume inspect "$VOLUME" > /dev/null 2>&1; then
          echo "âš ï¸  Volume $VOLUME introuvable, passage au suivant"
          exit 0
        fi
        
        # CrÃ©er le backup
        docker run --rm \
          -v "${VOLUME}:/source:ro" \
          -v "{{ backup_dir }}/volumes:/backup" \
          alpine sh -c "cd /source && tar czf /backup/${VOLUME}.tar.gz . 2>&1" || true
        
        # VÃ©rifier la taille
        if [ -f "$BACKUP_FILE" ]; then
          SIZE=$(du -h "$BACKUP_FILE" | cut -f1)
          echo "âœ… ${VOLUME}.tar.gz - Taille : $SIZE"
        else
          echo "âŒ Erreur : ${VOLUME}.tar.gz non crÃ©Ã©"
        fi
      loop: "{{ volumes }}"
      register: volume_backups
      failed_when: false

    # ============ BACKUP DE MARIADB ============
    - name: Sauvegarder MariaDB
      block:
        - name: RÃ©cupÃ©rer le mot de passe MariaDB du .env
          shell: |
            grep "MYSQL_ROOT_PASSWORD" "{{ project_dir }}/.env" | cut -d'=' -f2 | tr -d '"'
          register: mysql_password
          ignore_errors: yes

        - name: VÃ©rifier que MariaDB est accessible
          shell: |
            docker exec ansible-mariadb-1 mysql -u root -p'{{ mysql_password.stdout }}' -e "SELECT 1" > /dev/null 2>&1 && echo "OK" || echo "FAILED"
          register: mysql_check
          ignore_errors: yes

        - name: CrÃ©er dump MariaDB (avec mot de passe)
          shell: |
            docker exec ansible-mariadb-1 mysqldump \
              -u root \
              -p'{{ mysql_password.stdout }}' \
              --all-databases \
              --single-transaction \
              --quick \
              --lock-tables=false > "{{ backup_dir }}/databases/mariadb_dump.sql"
          register: mariadb_dump
          ignore_errors: yes
          when: mysql_check.stdout == "OK"

        - name: Compresser le dump MariaDB
          shell: |
            gzip -f "{{ backup_dir }}/databases/mariadb_dump.sql"
            ls -lh "{{ backup_dir }}/databases/mariadb_dump.sql.gz" | awk '{print "âœ… mariadb_dump.sql.gz - " $5}'
          register: mariadb_compress
          ignore_errors: yes
          when: mariadb_dump.changed

        - name: Afficher statut MariaDB
          debug:
            msg: "{{ mariadb_compress.stdout_lines | default(['âš ï¸  MariaDB backup Ã©chouÃ© ou ignorÃ©']) }}"

    # ============ BACKUP D'INFLUXDB ============
    - name: Sauvegarder InfluxDB
      block:
        - name: VÃ©rifier que InfluxDB est accessible
          shell: |
            docker exec ansible-influxdb-1 influx ping > /dev/null 2>&1 && echo "OK" || echo "FAILED"
          register: influxdb_check
          ignore_errors: yes

        - name: CrÃ©er un backup d'InfluxDB
          shell: |
            docker exec ansible-influxdb-1 sh -c 'influx backup /tmp/influxdb_backup -portable' 2>&1
          register: influxdb_backup
          ignore_errors: yes
          when: influxdb_check.stdout == "OK"

        - name: Copier le backup d'InfluxDB
          shell: |
            docker cp ansible-influxdb-1:/tmp/influxdb_backup "{{ backup_dir }}/databases/influxdb_backup"
          ignore_errors: yes
          when: influxdb_backup.changed

        - name: Compresser le backup d'InfluxDB
          shell: |
            cd "{{ backup_dir }}/databases"
            tar czf influxdb_backup.tar.gz influxdb_backup 2>&1
            rm -rf influxdb_backup
            ls -lh influxdb_backup.tar.gz | awk '{print "âœ… influxdb_backup.tar.gz - " $5}'
          register: influxdb_compress
          ignore_errors: yes

        - name: Afficher statut InfluxDB
          debug:
            msg: "{{ influxdb_compress.stdout_lines | default(['âš ï¸  InfluxDB backup Ã©chouÃ© ou ignorÃ©']) }}"

    # ============ BACKUP DE MONGODB ============
    - name: Sauvegarder MongoDB
      block:
        - name: VÃ©rifier que MongoDB est accessible
          shell: |
            docker exec ansible-mongodb-1 mongosh --eval "db.adminCommand('ping')" > /dev/null 2>&1 && echo "OK" || echo "FAILED"
          register: mongodb_check
          ignore_errors: yes

        - name: CrÃ©er un dump de MongoDB
          shell: |
            docker exec ansible-mongodb-1 mongodump \
              --archive=/tmp/mongodb_dump.archive \
              --gzip 2>&1
          register: mongodb_dump
          ignore_errors: yes
          when: mongodb_check.stdout == "OK"

        - name: Copier le dump de MongoDB
          shell: |
            docker cp ansible-mongodb-1:/tmp/mongodb_dump.archive \
              "{{ backup_dir }}/databases/mongodb_dump.archive"
            docker exec ansible-mongodb-1 rm /tmp/mongodb_dump.archive
            ls -lh "{{ backup_dir }}/databases/mongodb_dump.archive" | awk '{print "âœ… mongodb_dump.archive - " $5}'
          register: mongodb_copy
          ignore_errors: yes
          when: mongodb_dump.changed

        - name: Afficher statut MongoDB
          debug:
            msg: "{{ mongodb_copy.stdout_lines | default(['âš ï¸  MongoDB backup Ã©chouÃ© ou ignorÃ©']) }}"

    # ============ STATISTIQUES ============
    - name: Calculer les statistiques
      block:
        - name: Taille totale du backup
          shell: |
            du -sh "{{ backup_dir }}" | awk '{print $1}'
          register: backup_size

        - name: Compter les fichiers
          shell: |
            find "{{ backup_dir }}" -type f | wc -l
          register: file_count

        - name: Lister les fichiers
          shell: |
            find "{{ backup_dir }}" -type f -exec ls -lh {} \; | awk '{print $9, "(" $5 ")"}'
          register: file_list

    # ============ CRÃ‰ER LE MANIFEST ============
    - name: CrÃ©er le fichier manifest
      copy:
        dest: "{{ backup_dir }}/BACKUP_MANIFEST.txt"
        content: |
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘           MANIFEST DE SAUVEGARDE - {{ current_date }}          â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

          ğŸ“ LOCALISATION
          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          RÃ©pertoire : {{ backup_dir }}
          Taille totale : {{ backup_size.stdout }}
          Nombre de fichiers : {{ file_count.stdout }}
          Hostname : {{ inventory_hostname }}

          ğŸ“¦ VOLUMES SAUVEGARDÃ‰S
          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          {% for volume in volumes %}
          âœ“ {{ volume }}.tar.gz
          {% endfor %}

          ğŸ’¾ BASES DE DONNÃ‰ES
          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          âœ“ mariadb_dump.sql.gz
          âœ“ influxdb_backup.tar.gz
          âœ“ mongodb_dump.archive

          ğŸ“‹ LISTE DES FICHIERS
          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          {% for file in file_list.stdout_lines %}
          {{ file }}
          {% endfor %}

          ğŸ”„ COMMANDES DE RESTAURATION
          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

          ğŸ“‚ Restaurer un volume :
          docker run --rm \\
            -v VOLUME_NAME:/data \\
            -v {{ backup_dir }}/volumes:/backup \\
            alpine tar xzf /backup/VOLUME_NAME.tar.gz -C /data

          ğŸ—„ï¸  Restaurer MariaDB :
          gunzip < {{ backup_dir }}/databases/mariadb_dump.sql.gz | \\
          docker exec -i ansible-mariadb-1 mysql -u root -p

          ğŸ“Š Restaurer InfluxDB :
          tar xzf {{ backup_dir }}/databases/influxdb_backup.tar.gz -C /tmp && \\
          docker exec ansible-influxdb-1 influx restore /tmp/influxdb_backup -portable

          ğŸƒ Restaurer MongoDB :
          docker exec -i ansible-mongodb-1 mongorestore \\
            --archive=/dev/stdin --gzip \\
            < {{ backup_dir }}/databases/mongodb_dump.archive

          âš ï¸  NOTES IMPORTANTES
          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          â€¢ VÃ©rifier que les services sont arrÃªtÃ©s avant restauration
          â€¢ S'assurer que les volumes existent ou les crÃ©er
          â€¢ Tester la restauration sur un environnement de test
          â€¢ Conserver cette sauvegarde dans un lieu sÃ»r
          â€¢ DurÃ©e de rÃ©tention : {{ retention_days }} jours

        mode: '0644'

    # ============ NETTOYAGE DES ANCIENS BACKUPS ============
    - name: Nettoyer les backups anciens
      block:
        - name: Lister les anciens backups
          shell: |
            find {{ backup_base_dir }} -mindepth 1 -maxdepth 1 -type d -mtime +{{ retention_days }}
          register: old_backups
          ignore_errors: yes

        - name: Supprimer les anciens backups
          shell: |
            find {{ backup_base_dir }} -mindepth 1 -maxdepth 1 -type d -mtime +{{ retention_days }} -exec rm -rf {} \;
          register: cleanup
          ignore_errors: yes

        - name: Afficher les suppression
          debug:
            msg: |
              ğŸ—‘ï¸  Suppression des backups > {{ retention_days }} jours
              Backups supprimÃ©s :
              {% if old_backups.stdout_lines %}
              {% for backup in old_backups.stdout_lines %}
              - {{ backup }}
              {% endfor %}
              {% else %}
              Aucun ancien backup Ã  supprimer
              {% endif %}

  post_tasks:
    - name: CrÃ©er un fichier de log
      copy:
        dest: "{{ backup_dir }}/backup.log"
        content: |
          BACKUP LOG
          ===========================================
          Timestamp : {{ current_date }}
          Status : SUCCESS
          Directory : {{ backup_dir }}
          Size : {{ backup_size.stdout }}
          Files : {{ file_count.stdout }}
          Retention : {{ retention_days }} days
        mode: '0644'

    - name: Afficher le rÃ©sumÃ© final
      debug:
        msg: |
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘                  âœ… SAUVEGARDE TERMINÃ‰E âœ…                      â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

          ğŸ“¦ RÃ‰SUMÃ‰
          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          ğŸ“ Emplacement : {{ backup_dir }}
          ğŸ’¾ Taille totale : {{ backup_size.stdout }}
          ğŸ“„ Nombre de fichiers : {{ file_count.stdout }}
          â° Date/Heure : {{ current_date }}

          ğŸ“Š DÃ‰TAILS
          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          Volumes sauvegardÃ©s : {{ volumes | length }}
          Bases de donnÃ©es : 3 (MariaDB, InfluxDB, MongoDB)
          Configurations : 2 (.env, docker-compose.yml)

          ğŸ“‹ FICHIER MANIFEST
          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          Consultez : {{ backup_dir }}/BACKUP_MANIFEST.txt

          ğŸ”’ RECOMMANDATIONS DE SÃ‰CURITÃ‰
          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          âœ“ Copier les backups sur un stockage externe
          âœ“ Chiffrer les donnÃ©es sensibles
          âœ“ VÃ©rifier l'intÃ©gritÃ© pÃ©riodiquement
          âœ“ Tester la restauration rÃ©guliÃ¨rement

          ğŸš€ Prochaines Ã©tapes :
          - Sauvegarder externellement : {{ backup_dir }}
          - VÃ©rifier l'intÃ©gritÃ© : tar -tzf {{ backup_dir }}/volumes/*.tar.gz
          - Documenter les identifiants de restauration