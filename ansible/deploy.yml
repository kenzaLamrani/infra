---
- name: DÃ©ploiement de l'infrastructure Docker
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    project_dir: "/ansible"
    env_file: "{{ project_dir }}/.env"
    compose_file: "{{ project_dir }}/docker-compose.yml"
    
  tasks:
    - name: Installer Docker CLI et Docker Compose dans le conteneur
      shell: |
        apk add --no-cache docker-cli docker-cli-compose
      args:
        creates: /usr/bin/docker-compose

    - name: VÃ©rifier que le fichier .env existe
      stat:
        path: "{{ env_file }}"
      register: env_file_check
      
    - name: Afficher un message si .env n'existe pas
      debug:
        msg: "âš ï¸  Attention : Le fichier .env n'existe pas. CrÃ©ez-le avec les variables nÃ©cessaires."
      when: not env_file_check.stat.exists
      
    - name: ArrÃªter si .env n'existe pas
      fail:
        msg: "Le fichier .env est obligatoire pour le dÃ©ploiement"
      when: not env_file_check.stat.exists

    - name: VÃ©rifier que docker-compose.yml existe
      stat:
        path: "{{ compose_file }}"
      register: compose_file_check
      
    - name: ArrÃªter si docker-compose.yml n'existe pas
      fail:
        msg: "Le fichier docker-compose.yml est introuvable"
      when: not compose_file_check.stat.exists

    - name: CrÃ©er les rÃ©pertoires nÃ©cessaires pour Grafana
      file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
      loop:
        - "{{ project_dir }}/grafana/provisioning/datasources"
        - "{{ project_dir }}/grafana/provisioning/dashboards"

    - name: CrÃ©er la configuration de datasource Grafana pour InfluxDB
      copy:
        dest: "{{ project_dir }}/grafana/provisioning/datasources/influxdb.yml"
        content: |
          apiVersion: 1
          datasources:
            - name: InfluxDB
              type: influxdb
              access: proxy
              url: http://influxdb:8086
              database: telegraf
              isDefault: true
              editable: true
        mode: '0644'

    - name: CrÃ©er la configuration de provisioning des dashboards Grafana
      copy:
        dest: "{{ project_dir }}/grafana/provisioning/dashboards/dashboards.yml"
        content: |
          apiVersion: 1
          providers:
            - name: 'Default'
              orgId: 1
              folder: ''
              type: file
              disableDeletion: false
              updateIntervalSeconds: 10
              allowUiUpdates: true
              options:
                path: /etc/grafana/provisioning/dashboards
        mode: '0644'

    - name: ArrÃªter les conteneurs existants (si prÃ©sents)
      shell: |
        docker-compose down
      args:
        chdir: "{{ project_dir }}"
      ignore_errors: yes

    - name: DÃ©marrer l'infrastructure avec Docker Compose
      shell: |
        docker-compose up -d
      args:
        chdir: "{{ project_dir }}"
      register: compose_up

    - name: Attendre que les services soient dÃ©marrÃ©s
      pause:
        seconds: 20

    - name: VÃ©rifier l'Ã©tat des conteneurs
      shell: |
        docker-compose ps
      args:
        chdir: "{{ project_dir }}"
      register: containers_status

    - name: Afficher l'Ã©tat des conteneurs
      debug:
        msg: "{{ containers_status.stdout_lines }}"

    - name: CrÃ©er la base de donnÃ©es Telegraf dans InfluxDB
      shell: |
        docker exec ansible-influxdb-1 influx -execute 'CREATE DATABASE telegraf'
      ignore_errors: yes
      register: influx_db_creation

    - name: Afficher les informations de connexion
      debug:
        msg: |
          ğŸš€ DÃ©ploiement terminÃ© avec succÃ¨s !
          
          ğŸ“Š Services disponibles :
          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          ğŸ« GLPI (Ticketing)      : http://localhost:8180
          ğŸ“ˆ Grafana (Monitoring)  : http://localhost:3000
          ğŸ’¾ InfluxDB              : http://localhost:8086
          ğŸ—„ï¸  MongoDB              : mongodb://localhost:27017
          
          ğŸ”‘ Identifiants par dÃ©faut :
          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          Grafana : admin / Admin123
          GLPI    : glpi / glpi (premiÃ¨re connexion)
          
          âš™ï¸  Commandes utiles :
          docker-compose ps          # Voir l'Ã©tat des conteneurs
          docker-compose logs -f     # Voir les logs en temps rÃ©el
          docker-compose restart     # RedÃ©marrer tous les services