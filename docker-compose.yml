
services:
  # ----------------------------------------------------
  # 1. OUTIL DE TICKETING (GLPI)
  # ----------------------------------------------------
  mariadb:
    image: mariadb:10.11
    environment:
      MARIADB_ROOT_PASSWORD: ${MARIADB_ROOT_PASSWORD}
      MARIADB_DATABASE: glpi
      MARIADB_USER: glpi
      MARIADB_PASSWORD: ${GLPI_DB_PASSWORD}
    command:
      # Optimisations lÃ©gÃ¨res pour un environnement de test
      - --innodb-buffer-pool-size=32M  # RÃ©duction de 64M Ã  32M
      - --max-connections=50
      - --skip-name-resolve
    volumes:
      - mariadb_data:/var/lib/mysql
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h 127.0.0.1 -uroot -p\"$MARIADB_ROOT_PASSWORD\" || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks: [db]
    restart: unless-stopped

  glpi:
    image: diouxx/glpi
    depends_on:
      mariadb:
        condition: service_healthy
    environment:
      GLPI_DB_HOST: mariadb
      GLPI_DB_USER: glpi
      GLPI_DB_PASSWORD: ${GLPI_DB_PASSWORD}
      GLPI_DB_NAME: glpi
    ports:
      - "8180:80"
    networks: [edge, db]
    restart: unless-stopped

  # ----------------------------------------------------
  # 2. HISTORISATION & MONITORING (InfluxDB + Grafana)
  # Remplacement d'Elasticsearch/Kibana/Prometheus
  # ----------------------------------------------------
  influxdb:
    image: influxdb:1.8
    # InfluxDB 1.8 est plus lÃ©ger que la version 2.x
    volumes:
      - influxdb_data:/var/lib/influxdb
    ports:
      - "8086:8086"
    networks: [data]
    restart: unless-stopped
    # Pas de healthcheck trop agressif

  grafana:
    image: grafana/grafana
    # Grafana reste l'outil de monitoring (visualisation) [cite: 13]
    environment:
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_ADMIN_PASSWORD}
    volumes:
      - grafana_data:/var/lib/grafana
      # Vous devez crÃ©er le dossier ./grafana/provisioning
      - ./grafana/provisioning:/etc/grafana/provisioning
    ports:
      - "3000:3000"
    networks: [edge, data]
    restart: unless-stopped

  telegraf:
    image: telegraf:latest
    user: root  # ðŸ‘ˆ ajoute ceci pour Ã©viter les erreurs de permission
    volumes:
      - ./telegraf/telegraf.conf:/etc/telegraf/telegraf.conf:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro  # Pour les mÃ©triques Docker
      - /proc:/host/proc:ro      # ðŸ‘ˆ nÃ©cessaire pour inputs.system, cpu, mem, disk, net
      - /sys:/host/sys:ro        # ðŸ‘ˆ idem
      - /:/rootfs:ro             # ðŸ‘ˆ optionnel, utile pour certaines mÃ©triques disque
    environment:
      HOST_PROC: /host/proc
      HOST_SYS: /host/sys
    networks: [data]
    depends_on:
      - influxdb
    restart: unless-stopped


  # ----------------------------------------------------
  # 3. DATALAKE / BDD NO-SQL (MongoDB)
  # Remplacement de Cassandra par MongoDB (plus simple Ã  gÃ©rer)
  # ----------------------------------------------------
  mongodb:
    image: mongo:4.4
    # Plus lÃ©ger et plus facile Ã  dÃ©marrer que Cassandra en mono-nÅ“ud
    volumes:
      - mongodb_data:/data/db
    ports:
      - "27017:27017"
    networks: [data]
    restart: unless-stopped
    
networks:
  edge: {}
  data: {}
  db: {}

volumes:
  mariadb_data: {}
  grafana_data: {}
  influxdb_data: {}
  mongodb_data: {}